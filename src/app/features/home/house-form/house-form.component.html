<div class="house-form-container">
  <ngx-spinner size="medium" color="#fff" type="ball-scale-multiple">
    <p style="font-size: 20px; color: white">Loading...</p>
  </ngx-spinner>
  <mat-card class="house-form-card">
    <mat-card-title>{{
      isEditMode ? "Edit your house" : "Create a new house"
    }}</mat-card-title>

    <mat-progress-bar
      class="progress-bar"
      mode="determinate"
      [value]="progress"
      color="primary"
    ></mat-progress-bar>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <h4>Property Details</h4>
      <mat-form-field class="full-width">
        <mat-label>Name</mat-label>
        <input matInput formControlName="name" required />
        @if (form.get('name')?.invalid && form.get('name')?.touched) {
        <mat-error> This field is required. </mat-error>
        }
      </mat-form-field>

      <mat-form-field class="full-width">
        <mat-label>Type of Business</mat-label>
        <mat-select formControlName="typeOfBusiness" required>
          <mat-option value="sell">Sell</mat-option>
          <mat-option value="rent">Rent</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="full-width">
        <mat-label>Property Type</mat-label>
        <mat-select formControlName="propertyType" required>
          <mat-optgroup label="Residential">
            @for (type of residentialPropertyTypes; track type) {
            <mat-option [value]="type.value">
              <mat-icon>{{ type.icon }}</mat-icon> {{ type.viewValue }}
            </mat-option>
            }
          </mat-optgroup>
          <mat-optgroup label="Commercial">
            @for (type of commercialPropertyTypes; track type) {
            <mat-option [value]="type.value">
              <mat-icon>{{ type.icon }}</mat-icon> {{ type.viewValue }}
            </mat-option>
            }
          </mat-optgroup>
        </mat-select>
      </mat-form-field>

      <h4>Location</h4>
      <mat-form-field class="full-width">
        <mat-label>State</mat-label>
        <input
          type="text"
          matInput
          formControlName="state"
          [matAutocomplete]="autoState"
          required
        />
        <mat-autocomplete #autoState="matAutocomplete" autoActiveFirstOption>
          @for (st of filteredStates | async; track trackByStateId($index, st))
          {
          <mat-option [value]="st.name">{{ st.name }}</mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field class="full-width">
        <mat-label>City</mat-label>
        <input
          type="text"
          matInput
          formControlName="city"
          [matAutocomplete]="autoCity"
          required
        />
        <mat-autocomplete #autoCity="matAutocomplete" autoActiveFirstOption>
          @for (city of filteredCities | async; track trackByCityId($index,
          city)) {
          <mat-option [value]="city">{{ city }}</mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>

      <h4>Pricing & Units</h4>
      <mat-form-field class="full-width">
        <mat-label>Available Units</mat-label>
        <input
          matInput
          type="number"
          formControlName="availableUnits"
          required
          min="0"
        />
      </mat-form-field>

      <mat-form-field class="full-width">
        <mat-label>{{ priceLabel }}</mat-label>
        <input
          matInput
          type="number"
          formControlName="price"
          required
          min="1"
        />
      </mat-form-field>

      <h4>Amenities</h4>
      <div class="checkbox-group">
        <mat-checkbox formControlName="wifi">Wi-Fi Available</mat-checkbox>
        <mat-checkbox formControlName="laundry">Laundry Available</mat-checkbox>
      </div>

      <h4>Property Image</h4>
      @if (imagePreview) {
      <div class="image-preview">
        <img [src]="imagePreview" alt="Preview" />
      </div>
      }
      <div class="file-upload">
        <button type="button" mat-icon-button (click)="fileInput.click()">
          <mat-icon>upload</mat-icon>
        </button>
        <span>Select image</span>
        <input
          #fileInput
          type="file"
          hidden
          (change)="onImageSelected($event)"
          accept="image/*"
        />
      </div>

      <div class="actions">
        @if (isEditMode) {
        <button
          mat-stroked-button
          color="warn"
          type="button"
          (click)="onDelete()"
        >
          Delete
        </button>
        }
        <button mat-stroked-button type="button" (click)="onCancel()">
          Cancel
        </button>
        <button
          mat-flat-button
          color="primary"
          type="submit"
          [disabled]="form.invalid"
        >
          {{ isEditMode ? "Save Changes" : "Create House" }}
        </button>
      </div>
    </form>
  </mat-card>
</div>
